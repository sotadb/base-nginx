#!/bin/sh

process_inotifyd() {
	case $# in
		3)
			case $1 in
				n)
					if [ $(cat $2/$3) != $(consul kv get nginx/challange) ]; then
						consul kv put nginx/challange @$2/$3
						consul kv put nginx/challange-name $3
					fi
				;;
				d)
					consul kv delete nginx/challange
					consul kv delete nginx/challange-name
				;;
				*)
					echo "unknown operation from inotifyd"
				;;
			esac
		;;
		*)
			echo "invalid number of options for process_inotifyd()"
		;;
	esac
}

case $1 in
	health)
		ls /etc/nginx/nginx.conf /etc/nginx/ssl/fullchain.pem /etc/nginx/ssl/key.pem /etc/nginx/ssl/accnt.pem >/dev/null 2>&1
		return $?
	;;
	watch-challange)
		inotifyd process_inotifyd /var/www/.well-known/acme-challange:n
	;;
	client)
		consul lock nginx/acme $0 do_client
	;;
#consul lock doesn't seem to work with a shell function, so it must be independently called
	do_client)
		echo $$ > /var/run/acme-client.pid
		if consul kv get nginx/accnt.pem 2> /dev/null; then
			consul kv get nginx/accnt.pem > /etc/nginx/ssl/accnt.pem
		fi
		if consul kv get nginx/key.pem 2> /dev/null; then
			consul kv get nginx/key.pem > /etc/nginx/ssl/key.pem
		fi
		if consul kv get nginx/fullchain.pem 2> /dev/null; then
			consul kv get nginx/fullchain.pem > /etc/nginx/ssl/fullchain.pem
		fi
		if acme-client -nNOs -c /etc/nginx/ssl/ -f /etc/nginx/ssl/accnt.pem -k /etc/nginx/ssl/key.pem ${DOMAIN_NAMES}; then
			consul kv put nginx/accnt.pem @/etc/nginx/ssl/accnt.pem
			consul kv put nginx/key.pem @/etc/nginx/ssl/key.pem
			consul kv put nginx/fullchain.pem @/etc/nginx/ssl/fullchain.pem
			/usr/bin/consul-template -once -template /etc/nginx/nginx.hcl:/etc/nginx/nginx.conf
			/usr/sbin/nginx -s reload
		fi
		sleep 13h
		rm /var/run/acme-client.pid
	;;	
	*)
		echo "commands: health, watch-challange, client"
	;;
esac

