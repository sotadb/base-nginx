#!/bin/sh

case $1 in
	client)
		consul lock nginx/acme $0 do_client
	;;
#consul lock doesn't seem to work with a shell function, so it must be independently called
	do_client)
		echo $$ > /var/run/acme.pid
		if acme-client -enNOs -c /etc/ssl/acme/ -f /etc/ssl/acme/accnt.pem -k /etc/ssl/acme/key.pem -C /etc/ssl/acme/challange/ \
				$(consul kv get acme/domains); then
			printf $(date +%s) > /etc/ssl/acme/configured
		fi
		sleep 13h &
		wait
		rm /var/run/acme.pid
	;;
	init)
		consul lock acme/init $0 do_init
#consul lock doesn't seem to work with a shell function, so it must be independently called
	;;
	do_init)
		CONSUL_NAMES=$( consul kv get acme/domains 2>/dev/null )
		NEW_NAMES=$( echo ${CONSUL_NAMES} ${DOMAIN_NAMES} | awk '{line=""; for (i=1; i<=NF; i++) {if (line !~ $i) { line=line $i " "}}; print line}' )
		if [ "${CONSUL_NAMES}" != "${NEW_NAMES}" ]; then
			consul kv put acme/domains "${NEW_NAMES}"
		fi
		if [ ! -e "/etc/ssl/acme/dhparams.pem" ]; then
			openssl dhparam -out /etc/ssl/acme/dhparams.pem 2048
		fi
		if [ ! -e "/etc/ssl/acme/configured" ]; then
			printf 0 > /etc/ssl/acme/configured
		fi
		if [ ! -d "/etc/ssl/acme/challange" ]; then
			mkdir /etc/ssl/acme/challange
			ln -s /etc/ssl/acme/challange/ /var/www/acme
		fi
	;;
	watch)
		consul watch -type=key -key=acme/domains $0 kill_client
	;;
#I don't expect watch to be any better then lock, so it's independently called
	kill_client)
		if [ -e "/var/run/acme.pid" ]; then
			kill $( cat /var/run/acme.pid )
		fi
	;;
	*)
		echo "commands: init, client, watch"
	;;
esac

